<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Webflix - Movie Details</title>
  <link rel="stylesheet" href="../css/main.css" />
  <link rel="stylesheet" href="../css/bulma.min.css">
  <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body class="details-page">
  <nav class="navbar">
    <div class="container">
      <div class="navbar-brand">
        <a class="navbar-item is-size-4 has-text-weight-bold" href="homePage.html">
          <span class="has-text-white">Web<span class="has-text-info">flix</span></span>
        </a>
      </div>
      <div class="navbar-menu is-active" style="background: transparent; box-shadow: none;">
        <div class="navbar-end">
          <div class="navbar-item">
            <a class="button is-small is-ghost has-text-grey-light" href="javascript:history.back()">
              <i data-lucide="arrow-left" class="mr-1"></i> Back
            </a>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <section class="section">
    <div class="container">
      <div id="not-found" class="notification is-warning is-hidden">
        Movie details not found. Try returning to the gallery.
      </div>

      <!-- Main movie root: starts hidden until populated -->
      <div id="movie-root" class="is-hidden">

        <!-- Top Section -->
        <div class="columns is-variable is-8">
          <!-- Poster Column -->
          <div class="column is-3-desktop is-4-tablet">
            <figure class="image mb-4">
              <img id="movie-poster" class="poster-image" alt="movie poster" />
            </figure>
            <div id="poster-actions" class="buttons is-centered"></div>
          </div>

          <!-- Details Column -->
          <div class="column is-6-desktop is-8-tablet">
            <h1 id="movie-title" class="title is-1 is-size-2-mobile mb-2"></h1>

            <div class="is-flex is-align-items-center mb-4" style="gap: 0.75rem; flex-wrap: wrap;">
              <span id="movie-rating" class="has-text-warning is-size-4 has-text-weight-bold"></span>
              <h2 id="movie-sub" class="subtitle is-5 mb-0"></h2>
            </div>

            <div id="movie-genres" class="tags mb-5"></div>

            <div class="content is-medium has-text-grey-light">
              <p id="movie-description"></p>
            </div>

            <!-- Downloads / Quick actions -->
            <div class="box mt-5" style="border: 1px solid #334155;">
              <h3 class="title is-6 has-text-grey-light mb-3">Downloads</h3>
              <div id="movie-downloads" class="buttons"></div>
            </div>
          </div>

          <!-- Similar Column (Sidebar) -->
          <div class="column is-3-desktop is-12-tablet">
            <h3 class="title is-5 has-text-white mb-4">You might also like</h3>
            <div id="similar-list" class="columns is-multiline is-mobile"></div>
          </div>
        </div>

        <hr style="background-color: #334155;" />

        <!-- Middle Section -->
        <div class="columns is-variable is-8">
          <div class="column is-8">
            <h3 class="title is-4 has-text-white">Plot Summary</h3>
            <div id="movie-summary" class="content has-text-grey-light mb-6"></div>

            <h3 class="title is-4 has-text-white">Cast</h3>
            <div id="movie-cast" class="tags are-medium mb-6"></div>

            <h3 class="title is-4 has-text-white">Comments</h3>
            <div id="comments-root" class="box">
              <div class="field">
                <div class="control">
                  <textarea id="comment-input" class="textarea" rows="2" placeholder="Add a comment..."></textarea>
                </div>
              </div>
              <div class="field has-text-right">
                <button id="comment-post" class="button is-info is-small">Post Comment</button>
              </div>
              <div id="comment-list" class="mt-4"></div>
            </div>
          </div>

          <div class="column is-4">
            <div class="box">
              <h3 class="title is-5 has-text-white mb-4">Details</h3>
              <ul id="movie-details-list" class="is-size-6 has-text-grey-light" style="list-style: none; margin: 0;">
              </ul>
            </div>

            <div class="mt-5">
              <h3 class="title is-5 has-text-white mb-3">Key Scenes</h3>
              <div id="movie-scenes"></div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </section>

  <script src="../js/generate-details.js"></script>
  <script>
    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }

    // Read key from query and populate template
    (function () {
      const params = new URLSearchParams(window.location.search);
      const key = params.get('key');
      if (!key) {
        document.getElementById('not-found').classList.remove('is-hidden');
        return;
      }

      const raw = sessionStorage.getItem(key);
      if (!raw) {
        document.getElementById('not-found').classList.remove('is-hidden');
        return;
      }

      let movie;
      try {
        movie = JSON.parse(raw);
      } catch (e) {
        document.getElementById('not-found').classList.remove('is-hidden');
        return;
      }

      // Populate fields
      document.getElementById('movie-root').classList.remove('is-hidden');
      document.getElementById('movie-poster').src = movie.poster || '';
      document.getElementById('movie-title').textContent = movie.title || 'Untitled';
      document.getElementById('movie-sub').textContent = (movie.year ? movie.year + ' • ' : '') + (movie.duration ? movie.duration + ' min' : '');
      document.getElementById('movie-rating').textContent = movie.rating ? '⭐ ' + movie.rating : '';
      document.getElementById('movie-description').textContent = movie.description || '';

      // genres
      const genresRoot = document.getElementById('movie-genres');
      genresRoot.innerHTML = '';
      if (Array.isArray(movie.genres)) {
        movie.genres.forEach((g) => {
          const span = document.createElement('span');
          span.className = 'tag is-info is-light';
          span.textContent = g;
          genresRoot.appendChild(span);
        });
      }

      // poster actions (download/trailer/share)
      const posterActions = document.getElementById('poster-actions');
      posterActions.innerHTML = '';
      const btnDownload = document.createElement('a');
      btnDownload.className = 'button is-fullwidth is-info is-outlined mb-2';
      btnDownload.textContent = 'Download Poster';
      btnDownload.href = movie.download || '#';
      if (movie.download) {
        btnDownload.setAttribute('target', '_blank');
        btnDownload.setAttribute('download', '');
      }
      posterActions.appendChild(btnDownload);

      const btnTrailer = document.createElement('a');
      btnTrailer.className = 'button is-fullwidth is-info';
      btnTrailer.textContent = 'Watch Trailer';
      btnTrailer.href = movie.trailer || '#';
      if (movie.trailer) {
        btnTrailer.setAttribute('target', '_blank');
      }
      posterActions.appendChild(btnTrailer);

      // downloads quick list
      const downloadsRoot = document.getElementById('movie-downloads');
      downloadsRoot.innerHTML = '';
      if (Array.isArray(movie.downloads) && movie.downloads.length) {
        movie.downloads.forEach(d => {
          const a = document.createElement('a');
          a.href = '#';
          a.className = 'button is-small is-fullwidth is-dark mb-2';
          a.textContent = (d.label || d.quality || 'Download');
          downloadsRoot.appendChild(a);
        });
      }

      // similar/recommended
      const similarRoot = document.getElementById('similar-list');
      similarRoot.innerHTML = '';
      if (Array.isArray(movie.similar) && movie.similar.length) {
        movie.similar.forEach(s => {
          const col = document.createElement('div');
          col.className = 'column is-half-mobile is-full-tablet';
          const card = document.createElement('div');
          card.className = 'card';
          const imgWrap = document.createElement('div');
          imgWrap.className = 'card-image';
          const fig = document.createElement('figure');
          fig.className = 'image is-3by4';
          const im = document.createElement('img');
          im.src = s.poster || '';
          im.alt = s.title || 'poster';
          im.style.objectFit = 'cover';
          im.style.width = '100%';
          im.style.height = '100%';
          fig.appendChild(im);
          imgWrap.appendChild(fig);
          const content = document.createElement('div');
          content.className = 'card-content';
          const p = document.createElement('p');
          p.className = 'title is-7 has-text-centered';
          p.textContent = s.title || '';
          content.appendChild(p);
          card.appendChild(imgWrap);
          card.appendChild(content);
          card.addEventListener('click', () => {
            // open similar film using generateDetails if available
            if (window.generateDetails) window.generateDetails(s);
          });
          col.appendChild(card);
          similarRoot.appendChild(col);
        });
      }

      // middle section: summary & cast
      document.getElementById('movie-summary').textContent = movie.summary || movie.description || '';
      const castRoot = document.getElementById('movie-cast');
      castRoot.innerHTML = '';
      if (Array.isArray(movie.cast)) {
        movie.cast.forEach(c => {
          const t = document.createElement('span');
          t.className = 'tag is-dark';
          t.textContent = c;
          castRoot.appendChild(t);
        });
      }

      // details list (languages, duration, producers...)
      const detailsList = document.getElementById('movie-details-list');
      detailsList.innerHTML = '';
      const details = [];
      if (movie.languages) details.push('Languages: ' + (Array.isArray(movie.languages) ? movie.languages.join(', ') : movie.languages));
      if (movie.director) details.push('Director: ' + movie.director);
      if (movie.producer) details.push('Producer: ' + movie.producer);
      if (movie.budget) details.push('Budget: ' + movie.budget);
      if (movie.boxOffice) details.push('Box office: ' + movie.boxOffice);
      details.forEach(d => { const li = document.createElement('li'); li.className = 'mb-2'; li.textContent = d; detailsList.appendChild(li); });

      // scenes
      const scenesRoot = document.getElementById('movie-scenes');
      scenesRoot.innerHTML = '';
      if (Array.isArray(movie.scenes)) {
        movie.scenes.forEach(sc => {
          const div = document.createElement('div');
          div.className = 'scene-tag';
          div.textContent = sc;
          scenesRoot.appendChild(div);
        });
      }

      // comments: simple in-session comment storage keyed by key+'_comments'
      const commentKey = key + '_comments';
      const commentInput = document.getElementById('comment-input');
      const commentPost = document.getElementById('comment-post');
      const commentList = document.getElementById('comment-list');

      function loadComments() {
        commentList.innerHTML = '';
        let arr = [];
        try { arr = JSON.parse(sessionStorage.getItem(commentKey) || '[]'); } catch (e) { arr = []; }
        arr.forEach(c => {
          const d = document.createElement('div');
          d.className = 'comment';
          const m = document.createElement('div');
          m.className = 'meta';
          m.textContent = (new Date(c.t)).toLocaleString();
          const b = document.createElement('div');
          b.textContent = c.text;
          d.appendChild(m);
          d.appendChild(b);
          commentList.appendChild(d);
        });
      }

      commentPost.addEventListener('click', () => {
        const txt = commentInput.value && commentInput.value.trim();
        if (!txt) return;
        let arr = [];
        try { arr = JSON.parse(sessionStorage.getItem(commentKey) || '[]'); } catch (e) { arr = []; }
        arr.unshift({ t: Date.now(), text: txt });
        sessionStorage.setItem(commentKey, JSON.stringify(arr));
        commentInput.value = '';
        loadComments();
      });

      loadComments();
    })();
  </script>
  <script type="module" src="../js/auth-check.js"></script>
</body>

</html>